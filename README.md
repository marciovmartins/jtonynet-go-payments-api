<a id="header"></a>

<!-- 
    Logo image generated by Bing IA: https://www.bing.com/images/create/
    Prompt: gopher azul, simbolo da linguagem golang com um bone laranja, trabalhando como caixa de supermercado com algumas maquinhas de cart√£o de credito e cart√µes em cima da mesa, estilo cartoon, historia em quadrinhos, fundo branco chapado para facilitar remo√ß√£o
-->
[<img src="./docs/assets/images/layout/header.png" alt="gopher azul, simbolo da linguagem golang com um bone laranja, trabalhando como caixa de supermercado com algumas maquinhas de cart√£o de credito e cart√µes em cima da mesa, estilo cartoon, historia em quadrinhos" />](#rgo-turn-based-challenge)

<!-- 
    icons by:
    https://devicon.dev/
    https://simpleicons.org/
-->
[<img src="./docs/assets/images/icons/go.svg" width="25px" height="25px" alt="Go Logo" title="Go">](https://go.dev/) [<img src="./docs/assets/images/icons/gin.svg" width="25px" height="25px" alt="Gin Logo" title="Gin">](https://gin-gonic.com/) [<img src="./docs/assets/images/icons/postgresql.svg" width="25px" height="25px" alt="PostgreSql Logo" title="PostgreSql">](https://www.postgresql.org/) [<img src="./docs/assets/images/icons/redis.svg" width="25px" height="25px" alt="Redis Logo" title="Redis">](https://redis.com/)  [<img src="./docs/assets/images/icons/docker.svg" width="25px" height="25px" alt="Docker Logo" title="Docker">](https://www.docker.com/) [<img src="./docs/assets/images/icons/ubuntu.svg" width="25px" height="25px Logo" title="Ubuntu" alt="Ubuntu" />](https://ubuntu.com/) [<img src="./docs/assets/images/icons/dotenv.svg" width="25px" height="25px" alt="Viper DotEnv Logo" title="Viper DotEnv">](https://github.com/spf13/viper) [<img src="./docs/assets/images/icons/github.svg" width="25px" height="25px" alt="GitHub Logo" title="GitHub">](https://github.com/jtonynet) [<img src="./docs/assets/images/icons/visualstudiocode.svg" width="25px" height="25px" alt="VsCode Logo" title="VsCode">](https://code.visualstudio.com/) [<img src="./docs/assets/images/icons/swagger.svg" width="25px" height="25px" alt="Swagger Logo" title="Swagger">](https://swagger.io/) [<img src="./docs/assets/images/icons/mermaidjs.svg" width="25px" height="25px" alt="MermaidJS Logo" title="MermaidJS">](https://mermaid.js.org/) [<img src="./docs/assets/images/icons/githubactions.svg" width="25px" height="25px" alt="GithubActions Logo" title="GithubActions">](https://docs.github.com/en/actions) 

 <!-- [<img src="./docs/assets/images/icons/grpc.svg" width="45px" alt="grpc Logo" title="grpc">](https://grpc.io/) [<img src="./docs/assets/images/icons/prometheus.svg" width="25px" height="25px" alt="Prometheus Logo" title="Prometheus">](https://prometheus.io/) [<img src="./docs/assets/images/icons/grafana.svg" width="25px" height="25px" alt="Grafana Logo" title="Grafana">](https://grafana.com/)  [<img src="./docs/assets/images/icons/gatling.svg" width="35px" height="35px" alt="Gatling Logo" title="Gatling">](https://gatling.com/) [<img src="./docs/assets/images/icons/rabbitmq.svg" width="25px" height="25px" alt="RabbitMQ Logo" title="RabbitMQ">](https://rabbitmq.com/) -->


[![Badge Status](https://img.shields.io/badge/STATUS-EM_DESENVOLVIMENTO-green)](#header) [![Github Project](https://img.shields.io/badge/PROJECT%20VIEW-KANBAN-green?logo=github&logoColor=white)](https://github.com/users/jtonynet/projects/7/views/1)  [![Badge GitHubActions](https://github.com/jtonynet/go-payments-api/actions/workflows/main.yml/badge.svg?branch=main)](https://github.com/jtonynet/go-payments-api/actions)
>


## üï∏Ô∏è Redes

[![linkedin](https://img.shields.io/badge/Linkedin-0A66C2?style=for-the-badge&logo=linkedin&logoColor=white)](https://www.linkedin.com/in/jos%C3%A9-r-99896a39/) [![dev.to](https://img.shields.io/badge/dev.to-0A0A0A?style=for-the-badge&logo=devdotto&logoColor=white)](https://dev.to/learningenuity) [![gmail](https://img.shields.io/badge/Gmail-D14836?style=for-the-badge&logo=gmail&logoColor=white)](mailto:learningenuity@gmail.com)

---

## üìÅ O Projeto

<a id="index"></a>
### ‚§¥Ô∏è √çndice


__[Go Payments API](#header)__<br/>
  1.  ‚§¥Ô∏è [√çndice](#index)
  2.  üìñ [Sobre](#about)
  3.  üíª [Rodando o Projeto](#run)
      - üåê [Ambiente](#environment)
      - üêã [Conteinerizado](#run-containerized)
      - üè† [Local](#run-locally)
  4.  üì∞ [Documenta√ß√£o da API](#api-docs)
  5.  ‚úÖ [Testes](#tests)
      - üêã [Conteinerizado](#test-containerized)
      - üè† [Local](#test-locally)
      - ‚öôÔ∏è[Automatizados](#test-auto)
      - üßë‚Äçüîß[Manuais](#test-manual)
  6.  üìä [Diagramas](#diagrams)
      - üìà [Fluxo](#diagrams-flowchart)
      - üìà [ER](#diagrams-erchart)
  7.  üÖª4Ô∏è‚É£ [Quest√£o Aberta L4](#open-question)
  8.  üëè [Boas Pr√°ticas](#best-practices)
  9.  üß† [ADR - Architecture Decision Records](#adr)
  10. üî¢ [Vers√µes](#versions)
  11. üß∞ [Ferramentas](#tools)
  12. ü§ñ [Uso de IA](#ia)
  13. üèÅ [Conclus√£o](#conclusion)

---

<a id="about"></a>
### üìñ Sobre

> Projeto j√° finalizado como `Desafio` e atendendo aos requisitos. Por√©m, o considerei t√£o interessante que decidi continuar seu desenvolvimento. Pretendo, ainda que de maneira local, atender ao requisito L4, embora tenha sido levantado apenas para esclarecimento, al√©m de outros t√≥picos interessantes.
> 
> 

Acompanhe as tarefas pelo __[Kanban](https://github.com/users/jtonynet/projects/7/views/1)__

Este reposit√≥rio foi criado com a inten√ß√£o de propor uma poss√≠vel solu√ß√£o para o seguinte desafio:

> <br/>
> 
> üë®‚Äçüíª __Desafio T√©cnico:__
>
> Al√©m de avaliar a corre√ß√£o da sua solu√ß√£o, temos interesse em ver como voc√™ modela o dom√≠nio, organiza seu c√≥digo e implementa seus testes. 
>
>
> __Linguagem e bibliotecas:__
> 
> Na *********, usamos Scala e Kotlin no nosso dia a dia (e demonstrar experi√™ncia em alguma delas √© um grande diferencial). No entanto, voc√™ pode implementar sua solu√ß√£o utilizando sua linguagem favorita, dando prefer√™ncia ao paradigma de programa√ß√£o funcional.
>
> __Como entregar a solu√ß√£o?__
> 
> Entregue a sua solu√ß√£o preferencialmente criando um reposit√≥rio git (Github, Gitlab, etc).
>
> √â muito importante escrever um arquivo README com as instru√ß√µes para execu√ß√£o do projeto.
> 
> Agora, vamos gui√°-lo atrav√©s de alguns conceitos b√°sicos.
> 
> <br/>
> 
> ---
> 
> <br/>
> 
> __Transaction__
>
> Uma vers√£o simplificada de um transaction payload de cart√£o de cr√©dito √© o seguinte:
>
> ```json
> {
> 	"account": "123",
> 	"totalAmount": 100.00,
> 	"mcc": "5811",
> 	"merchant": "PADARIA DO ZE               SAO PAULO BR"
> }
> ```
>
>
> __Atributos__
>
> - **id** - Um identificador uÃÅnico para esta transacÃßaÃÉo.
> - **accountId** - Um identificador para a conta.
> - **amount** - O valor a ser debitado de um saldo.
> - **merchant** - O nome do estabelecimento.
> - **mcc** - Um coÃÅdigo numeÃÅrico de 4 diÃÅgitos que classifica os estabelecimentos comerciais de acordo com o tipo de produto vendido ou servicÃßo prestado.
>    
>    O `MCC` conteÃÅm a classificacÃßaÃÉo do estabelecimento. Baseado no seu valor, deve-se decidir qual o saldo seraÃÅ utilizado (na totalidade do valor da transacÃßaÃÉo). Por simplicidade, vamos usar a seguinte regra:
>    
>    - Se o `mcc` for `"5411"` ou `"5412"`, deve-se utilizar o saldo de `FOOD`.
>    - Se o `mcc` for `"5811"` ou `"5812"`, deve-se utilizar o saldo de `MEAL`.
>    - Para quaisquer outros valores do `mcc`, deve-se utilizar o saldo de `CASH`.
>
> <br/>
> 
> ---
>
> <br/>
> 
> __Desafios (o que voc√™ deve fazer)__
> 
> Cada um dos desafios a seguir s√£o etapas na cria√ß√£o de um autorizador completo. Seu autorizador deve ser um servidor HTTP que processe a transaction payload JSON usando as regras a seguir.
>
> As poss√≠veis respostas s√£o:
> - `{ "code": "00" }` se a transa√ß√£o √© **aprovada**
> - `{ "code": "51" }` se a transa√ß√£o √© **rejeitada**, porque n√£o tem saldo suficiente
> - `{ "code": "07" }` se acontecer qualquer outro problema que impe√ßa a transa√ß√£o de ser processada
>
> __O HTTP Status Code √© sempre `200`__
> 
>
><br/>
>
> 1. __L1. Autorizador simples__
>     - O __autorizador simples__ deve funcionar da seguinte forma:
>       -  Recebe a transa√ß√£o
>       -  Usa **apenas** a MCC para mapear a transa√ß√£o para uma categoria de benef√≠cios
>       -  Aprova ou rejeita a transa√ß√£o
>       -  Caso a transa√ß√£o seja aprovada, o saldo da categoria mapeada dever√° ser diminu√≠do em __totalAmount__.
>
> 2. __L2. Autorizador com fallback__
>     - Para despesas n√£o relacionadas a benef√≠cios, criamos outra categoria, chamada __CASH__. O autorizador com fallback deve funcionar como o autorizador simples, com a seguinte diferen√ßa:
>       - Se a MCC n√£o puder ser mapeado para uma categoria de benef√≠cios ou se o saldo da categoria fornecida n√£o for suficiente para pagar a transa√ß√£o inteira, verifica o saldo de **CASH** e, se for suficiente, debita esse saldo.
>
> 3. __L3.Dependente do comerciante__
>     - As vezes, os MCCs est√£o incorretos e uma transa√ß√£o deve ser processada levando em considera√ß√£o tamb√©m os dados do comerciante. Crie um mecanismo para substituir MCCs com base no nome do comerciante. O nome do comerciante tem maior preced√™ncia sobre as MCCs.
>     - Exemplos:
>       - `UBER TRIP                   SAO PAULO BR`
>       - `UBER EATS                   SAO PAULO BR`
>       - `PAG*JoseDaSilva          RIO DE JANEI BR`
>       - `PICPAY*BILHETEUNICO           GOIANIA BR`
>   
> 4. __L4. Quest√£o aberta__
>     - A seguir est√° uma quest√£o aberta sobre um recurso importante de um autorizador completo (que voc√™ n√£o precisa implementar, apenas discuta da maneira que achar adequada, como texto, diagramas, etc.).
>       - Transa√ß√µes simult√¢neas: dado que o mesmo cart√£o de cr√©dito pode ser utilizado em diferentes servi√ßos online, existe uma pequena mas existente probabilidade de ocorrerem duas transa√ß√µes ao mesmo tempo. O que voc√™ faria para garantir que apenas uma transa√ß√£o por conta fosse processada em um determinado momento? Esteja ciente do fato de que todas as solicita√ß√µes de transa√ß√£o s√£o s√≠ncronas e devem ser processadas rapidamente (menos de 100 ms), ou a transa√ß√£o atingir√° o timeout.
> 
> <br/>
> 
> ---
>
> <br/>
> 
> _Para este teste, tente ao m√°ximo implementar um sistema de autoriza√ß√£o de transa√ß√µes considerando todos os desafios apresentados (L1 a L4) e conceitos b√°sicos._
> 
> <br/>

<br/>

**Arquitetura Atual do Projeto**<br/>
Arquitetura m√≠nima atendendo requisito `L4`, com retentativas de aquisi√ß√£o de lock em caso de concorr√™ncia. Embora ainda n√£o esteja em sua vers√£o final, a implementa√ß√£o est√° funcional, validando em forma de `MVP` com uma solu√ß√£o de `Lock Distribu√≠do`. Abordagem `Growth Hack`, que dever√° escalar conforme o sugerido em [Quest√£o Aberta L4](#open-question) e na ADR [0003: gRPC e Redis Keyspace Notification em API REST e Worker para reduzir Lat√™ncia e evitar Concorr√™ncia](./docs/architecture/decisions/0003-grpc-e-redis-keyspace-notification-em-api-rest-e-worker-para-reduzir-latencia-e-evitar-concorrencia.md).

<center>
    <img src="./docs/assets/images/screen_captures/miro/minimun_architecture_with_exponential_retry_backoff.png">
</center>

<br/>

O desafio sugere `Scala`, `Kotlin` e o `paradigma de programa√ß√£o funcional`, evidenciando prefer√™ncias, mas aceitando subscri√ß√µes com outras linguagens e paradigmas. Realizarei em `Golang`, com arquitetura [`hexagonal`](https://alistair.cockburn.us/hexagonal-architecture/), por maior familiaridade e experi√™ncia al√©m de entender que essa linguagem e arquitetura se encaixam ao desafio.

Contudo, sou aberto a expandir minhas habilidades, e disposto a aprender e adotar novas tecnologias e paradigmas conforme necess√°rio.

<br/>

[‚§¥Ô∏è de volta ao √≠ndice](#index)

---

<a id="run"></a>
### üíª Rodando o Projeto

<a id="environment"></a>
#### üåê Ambiente

`Docker` e `Docker Compose` s√£o necess√°rios para rodar a aplica√ß√£o de forma containerizada, e √© fortemente recomendado utiliz√°-los para rodar o banco de dados localmente.

Crie uma copia do arquivo `./payments-api/.env.SAMPLE` e renomeie para `./payments-api/.env`.

<br/>

<a id="run-containerized"></a>
#### üêã Conteinerizado 

Ap√≥s a `.env` renomeada, rode os comandos `docker compose` (de acordo com sua vers√£o do docker compose) no diret√≥rio raiz do projeto:

```bash
# Construir a imagem
docker compose build

# Rodar o PostgreSQL e o Redis de Desenvolvimento
docker compose up postgres-payments redis-payments -d

# Rodar a API
docker compose up payments-api
```
 A API est√° pronta e a rota da [Documenta√ß√£o da API](#api-docs) (Swagger) estar√° dispon√≠vel, assim como os [Testes](#tests) poder√£o ser executados.

<br/>

<a id="run-locally"></a>
#### üè† Local

Com o `Golang 1.23` instalado e ap√≥s ter renomeado a copia de `.env.SAMPLE` para `.env`, ser√£o necess√°rias outras altera√ß√µes para que a aplica√ß√£o funcione corretamente no seu `localhost`.

No arquivo `.env`, substitua os valores das vari√°veis de ambiente que cont√™m coment√°rios no formato `local: valueA | containerized: valueB` pelos valores sugeridos na op√ß√£o `local`.
```bash
DATABASE_HOST=localhost ### local: localhost | conteinerized: postgres-payments
```

Ap√≥s editar o arquivo, suba apenas o banco de dados com o comando:

```bash
# Rodar o PostgreSQL de Desenvolvimento
docker compose up postgres-payments
```
ou se conecte a uma database v√°lida no arquivo `.env`, ent√£o no diret√≥rio `payments-api` execute os comandos:

```bash
# Instala Depend√™ncias
go mod download

# Rodar a API
go run cmd/http/main.go
```
 A API est√° pronta e a rota da [Documenta√ß√£o da API](#api-docs) (Swagger) estar√° dispon√≠vel, assim como os [Testes](#tests) poder√£o ser executados.

<br/>

[‚§¥Ô∏è de volta ao √≠ndice](#index)

---

<a id="api-docs"></a>
### üì∞  Documenta√ß√£o da API

####  <img src="./docs/assets/images/icons/swagger.svg" width="20px" height="20px" alt="Swagger" title="Swagger">  Swagger

Com a aplica√ß√£o em execu√ß√£o, a rota de documenta√ß√£o Swagger fica dispon√≠vel em http://localhost:8080/swagger/index.html

<img src="./docs/assets/images/screen_captures/swagger.png">

A interface do Swagger pode executar [Testes Manuais](#test-manual) a partir de `requests` no endpoint `POST: /payment` 

<br/>

[‚§¥Ô∏è de volta ao √≠ndice](#index)

---

<a id="tests"></a>
### ‚úÖ Testes

<a id="test-containerized"></a>
#### üêã Conteinerizado 
Para rodar os [Testes Automatizados](#test-auto) usando container, √© necess√°rio que j√° esteja [Rodando o Projeto Conteinerizado](#run-containerized).

As configura√ß√µes para executar os testes de reposit√≥rio e integra√ß√£o (dependentes de infraestrutura) de maneira _containerizada_ est√£o no arquivo `./payments-api/.env.TEST`. N√£o √© necess√°rio alter√°-lo ou renome√°-lo, pois a API o usar√° automaticamente se a vari√°vel de ambiente `ENV` estiver definida como `teste`.

<br/>

<a id="test-locally"></a>
#### üè† Local
Para rodar os [Testes Automatizados](#test-auto) com a API fora do container, de maneira _local_, √© necess√°rio editar seu `/.env.TEST`.

No arquivo `/.env.TEST`, substitua os valores das vari√°veis de ambiente que cont√™m coment√°rios no formato `local: valueA | containerized: valueB` pelos valores sugeridos na op√ß√£o `local`.
```bash
DATABASE_HOST=localhost         ### local: localhost | conteinerized: test-postgres-payments
DATABASE_PORT=5433              ### local: 5433 | conteinerized: 5432

IN_MEMORY_CACHE_HOST=localhost  ### local: localhost | conteinerized: redis-payments
IN_MEMORY_LOCK_HOST=localhost   ### local: localhost | conteinerized: redis-payments
```
<br/>

<a id="test-auto"></a>
#### ‚öôÔ∏è Automatizados

[Rodando o Projeto](#run) `payment-api`  em seu ambiente _local_ ou _conteinerizado_, levante o banco de testes com

```bash
# Rodar o PostgreSQL de Testes
docker compose up test-postgres-payments -d
```

Comando para executar o teste _conteinerizado_ com a API levantada
```bash
# Executa Testes no Docker com ENV test (PostgreSQL de Testes na Integra√ß√£o)
docker compose exec -e ENV=test payments-api go test -v -count=1 ./internal/adapter/repository ./internal/adapter/inMemoryRepository/redisRepos ./internal/core/service ./internal/adapter/http/router
```

Comando para executar o teste _local_ em `payments-api`
```bash
# Executa Testes Localmente com ENV test (PostgreSQL de Testes na Integra√ß√£o)
ENV=test go test -v -count=1  ./internal/adapter/repository ./internal/adapter/inMemoryRepository/redisRepos ./internal/core/service ./internal/adapter/http/router
```

<br/>

Cada vez que o comando for executado, as tabelas e √≠ndices da base de dados testada ser√£o truncados e recriados no banco de dados do ambiente selecionado (`test` ou `dev`). Os usu√°rios dos ambientes `homol`, `prod` e correlatos n√£o devem ter permiss√µes para executar essas a√ß√µes no pr√≥prio database, garantindo uma execu√ß√£o segura, limpa e sem impacto nos dados de produ√ß√£o.


<img src="./docs/assets/images/screen_captures/tests_run.png">

_*Sa√≠da esperada do comando_

<br/>

Os testes tamb√©m s√£o executados como parte da rotina minima de `CI` do <a href="https://github.com/jtonynet/go-payments-api/actions">GitHub Actions</a>, garantindo que vers√µes est√°veis sejam mescladas na branch principal. O badge `CI` no [cabe√ßalho](#header) do arquivo readme √© uma ajuda visual para verificar rapidamente a integridade do desenvolvimento.

<img src="./docs/assets/images/screen_captures/githubactions_tests_run.png">

_*Sa√≠da esperada do `workload` na fase test do `github` <br/> **Essa abordagem pode evoluir para uma rotina adequada de `CD`._ 


<br/>

<a id="test-manual"></a>
#### üßë‚ÄçüîßManuais

Como as `migrations` e `seeds` ainda n√£o foram adicionadas ao projeto, voc√™ pode rodar a suite de testes no ambiente de desenvolvimento (aten√ß√£o: isso trunca todas as tabelas antes de efetuar a carga de testes) para carregar os valores iniciais.

```bash
# Executa Testes no Docker com ENV dev (PostgreSQL de Desenvolvimento na Integra√ß√£o)
docker compose exec payments-api go test -v -count=1 ./internal/adapter/repository ./internal/adapter/inMemoryRepository/redisRepos ./internal/core/service ./internal/adapter/http/router
```

<br/>

Registros e Saldos para teste manual

L1. L2. Account e Saldos por Categoria
> 
> | __Account:__                                            | __AcountID:__ |
> |---------------------------------------------------------|---------------|
> |123e4567-e89b-12d3-a456-426614174000                     | 1             |
>
> ---
>
> | __Categoria__ | __MCCs__           | __Amount Dispon√≠vel na Categoria__ |
> |---------------|--------------------|------------------------------------|
> | FOOD          | 5411, 5412         | 105.01                             |
> | MEAL          | 5811, 5812         | 110.22                             |
> | CASH          |                    | 115.33                             |

<br/>

L3. Merchants com mapeamentos MCC incorretos
>
> | __Merchant__                             | __MCCs__           | __Mapeado para Categoria__ |
> |------------------------------------------|--------------------|----------------------------|
> | UBER EATS                   SAO PAULO BR | 5412               | FOOD                       |
> | PAG*JoseDaSilva          RIO DE JANEI BR | 5812               | MEAL                       |

<br/>

Query Consulta Balances por Account:
```sql
SELECT
   b.account_id, 
   b.id AS balance_id,
   b.uid AS balance_uid, 
   b.amount, 
   c.name, 
   c.priority, STRING_AGG(mc.mcc, ',') AS codes 
FROM 
	balances AS b 
JOIN 
	categories AS c ON b.category_id = c.id 
LEFT JOIN 
	mccs AS mc ON c.id = mc.category_id 
WHERE
	b.account_id = 1 
GROUP by
	b.account_id, b.id, b.uid, b.amount, c.name, c.priority;
```


_*Com acesso ao banco a partir dos dados de `.env`, para validar. Bem como a [Documenta√ß√£o da API](#api-docs) (Swagger) pode ser utilizado para proceder as `requests`. <br/> **Utilize o campo `name` real da tabela `merchant`, o github pode formatar de maneira incorreta esse dado no markdown._

<br/>

[‚§¥Ô∏è de volta ao √≠ndice](#index)

---

<a id="diagrams"></a>
### üìä Diagramas do Sistema
_*Diagramas Mermaid podem apresentar problemas de visualiza√ß√£o em aplicativos mobile_

<!-- 
    diagrams by:
    https://mermaid.js.org/
-->

<a id="diagrams-flowchart"></a>
#### üìà Fluxo
__Autoriza√ß√£o de Pagamento__

```mermaid
flowchart TD
    A([‚ñ∂Ô∏è<br/>Recebe Transa√ß√£o JSON]) --> B[Mapeia Categoria pelo nome do comerciante]
    B --> C[Buscar Saldos da Conta]
    C --> D{Saldo √© suficiente <br/> na Categoria?}
    
    D -- Sim --> E[Debita Saldo da Categoria]
    D -- N√£o --> F{Saldo suficiente na <br/> Categoria e CASH?}
    
    F -- Sim --> G[Debita Categoria e CASH]
    F -- N√£o --> H{Saldo suficiente em CASH?}
    
    H -- Sim --> I[Debita Saldo de CASH]
    H -- N√£o --> J[Rejeita Transa√ß√£o com C√≥digo 51]
    
    E --> K[Registrar Transa√ß√£o Aprovada]
    G --> K[Registrar Transa√ß√£o Aprovada]
    I --> K[Registrar Transa√ß√£o Aprovada]
    
    K --> P{Ocorreu Erro no Processo da Transa√ß√£o?}
    P -- Sim --> Q[‚ùå<br/><b>Rejeitada</b><br/> Retorna C√≥digo <b>07</b> por Falha Gen√©rica</b>]
        P -- N√£o --> M[‚úÖ<br/><b>Aprovada</b><br/> Retorna C√≥digo <b>00</b>]
    
    J --> N[‚ùå<br/><b>Rejeitada</b><br/> Retorna C√≥digo <b>51</b> por Saldo Insuficiente</b>]

    N --> O([‚èπÔ∏è<br/>Fim do Processo])
    M --> O
    Q --> O

    style M fill:#009933,stroke:#000
    style N fill:#cc0000,stroke:#000
    style Q fill:#cc0000,stroke:#000
```
_*Diagrama apresenta uma interpreta√ß√£o do sistema_

<a id="diagrams-flowchart-description"></a>
##### üìù Descri√ß√£o

1. **Recebe Transa√ß√£o JSON**: O sistema recebe o payload de transa√ß√£o.

2. **Mapeia MCC pelo Merchant Name**: Busca um relacionamento entre o `merchant` e uma categoria adequada. Caso categoria N√£o exista segue o fluxo para debitar de CASH

3. **Buscar Saldos da Conta**: A conta e os saldos (FOOD, MEAL, CASH) s√£o buscados no banco de dados 

4. **Saldo √© suficiente na Categoria?**: Verifica se o saldo dispon√≠vel na categoria mapeada (com base no MCC) √© suficiente.
    - Se sim, debita o saldo da categoria correspondente.
    - Se n√£o, verifica o saldo de CASH.

5. **Saldo suficiente em CASH?**: Se a categoria principal n√£o tiver saldo suficiente, o sistema verifica o saldo de CASH.
    - Se sim, debita parcial ou totalmente o saldo de CASH.
    - Se n√£o, rejeita a transa√ß√£o com o c√≥digo "51" (fundos insuficientes).

6. **Registrar Transa√ß√£o Aprovada**: A transa√ß√£o aprovada √© registrada no banco de dados.

7. **Retorna C√≥digo "00"**: Se a transa√ß√£o foi aprovada, retorna o c√≥digo "00" (aprovada).

8. **Retorna C√≥digo "51"**: Se a transa√ß√£o foi rejeitada por falta de fundos, retorna o c√≥digo "51".

<br/>

_*Esse fluxo representa o processo de aprova√ß√£o, fallback e rejei√ß√£o da transa√ß√£o com base nos saldos e MCC._

---

<br/>

<a id="diagrams-erchart"></a>
#### üìà ER

```mermaid
erDiagram
    accounts {
        int id PK
        UUID uid
        string name
        datetime created_at
        datetime updated_at
        timestamp deleted_at
    }

    balances {
        int id PK
        UUID uid
        int account_id FK
        int category_id FK
        numeric amount
        timestamp created_at
        timestamp updated_at
        timestamp deleted_at
    }

    transactions {
        int id PK
        UUID uid
        int account_id FK
        string mcc
        string merchant
        numeric total_amount
        timestamp created_at
        timestamp updated_at
        timestamp deleted_at
    }
    
    merchants {
        int id PK
        UUID uid
        string name
        int mcc_id FK
        timestamp created_at
        timestamp updated_at
        timestamp deleted_at
    }

   mccs {
        int id PK
        string mcc
        int category_id FK
        datetime created_at
        datetime updated_at
        timestamp deleted_at
    }

    categories {
        int id PK
        UUID uid
        string name
        int priority
        datetime created_at
        datetime updated_at
        timestamp deleted_at
    }

    categories ||--o{ balances : defines
    accounts ||--o{ transactions : performs
    categories ||--o{ mccs : has
    accounts ||--o{ balances : has
    mccs ||--o{ merchants : has
    

    
```
<a id="diagrams-erchart-description"></a>
##### üìù Descri√ß√£o

**accounts** Tabela principal, conectada tanto a **Balances** quanto a **Transactions**, armazenando informa√ß√µes sobre as contas.  
**balances** Armazena os saldos por categoria.<br/>
**transactions** Registra o hist√≥rico de transa√ß√µes realizadas.<br/>
**categories**: Cada categoria (FOOD, MEAL, CASH...) √© armazenada. O campo `priority` permite definir a prioridade ou a sequ√™ncia da categoria<br/>
**mccs** Cont√©m MCCs (c√≥digos de quatro d√≠gitos) e uma `category_id` correspondente, associada a categoria.<br/>
**merchant** para ajustar MCCs incorretos de acordo com o nome do comerciante.



<br/>

[‚§¥Ô∏è de volta ao √≠ndice](#index)

---

<a id="open-question"></a>
### üÖª4Ô∏è‚É£ Quest√£o Aberta L4

> Transa√ß√µes simult√¢neas: dado que o mesmo cart√£o de cr√©dito pode ser utilizado em diferentes servi√ßos online, existe uma pequena mas existente probabilidade de ocorrerem duas transa√ß√µes ao mesmo tempo. O que voc√™ faria para garantir que apenas uma transa√ß√£o por conta fosse processada em um determinado momento? Esteja ciente do fato de que todas as solicita√ß√µes de transa√ß√£o s√£o s√≠ncronas e devem ser processadas rapidamente (menos de 100 ms), ou a transa√ß√£o atingir√° o timeout.

#### üîí Locks Distribu√≠dos com Redis e Keyspace Notification

Utilizaria `Locks Distribu√≠dos` com `Bloqueio Pessimista`, for√ßando o processamento s√≠ncrono por `account`, mas mantendo a simultaneidade das opera√ß√µes onde esses dados sejam distintos. Um sistema de dados em mem√≥ria r√°pido, como `Redis`, seria utilizado para armazenar e liberar locks, coordenando o acesso a recursos compartilhados de maneira eficiente.

O processamento da transa√ß√£o verifica se a `account` j√° est√° registrada no `lock`. Se n√£o estiver, a aplica√ß√£o a insere no banco em mem√≥ria e inicia suas tarefas. Caso j√° esteja registrada, indicando que outra inst√¢ncia est√° processando uma transa√ß√£o para a mesma `account`, a aplica√ß√£o se inscreve em um canal, aguardando uma mensagem de desbloqueio por at√© 100 ms menos o tempo m√©dio de processamento, evitando concorr√™ncia.

Com [`Redis Keyspace Notifications`](https://redis.io/docs/latest/develop/use/keyspace-notifications/) (similar a `pub/sub`), quando o processamento terminar e a chave `account` for removida (pelo processo ou `ttl`), uma mensagem deve ser publicada pelo pr√≥prio `Redis` aos inscritos, sinalizando a libera√ß√£o do `lock`.


Como proposto na quest√£o _"...uma pequena, mas existente probabilidade de ocorrerem duas transa√ß√µes ao mesmo tempo"_, a concorr√™ncia excessiva por `account` n√£o deve ocorrer utilizando essa abordagem.


```mermaid
flowchart TD
    A([‚ñ∂Ô∏è<br/>Recebe Transa√ß√£o JSON]) --> B[Inicia Processamento de Transa√ß√£o]
    B --> C{Account da Transa√ß√£o est√° Bloqueado no <b>Lock Distribu√≠do</b>?}
    
    C -- N√£o --> D[üîê<br/><b>Bloqueia</b><br/>Account da Transa√ß√£o no Lock Distribu√≠do]
    D  --> E[[Processa Autoriza√ß√£o de Pagamento]]

    C -- Sim --> M[‚úâÔ∏è‚¨ÖÔ∏è<br/><b>Subscreve</b><br/>Redis Keyspace Notification<br/><br/> ]
    M --> R[‚è∏Ô∏è<br/><b>Aguarda</b><br> receber Mensagem de desbloqueio da Account do Redis Keyspace Notification]
    R --> N{Recebi Mensagem de desbloqueio em tempo √∫til? <br/> <b><i>t<i> < 100¬†ms - tempo m√©dio de processo</b>}
    N -- Sim --> D
    N -- N√£o --> O[‚ùå<br/><b>Rejeitada</b><br/> Retorna C√≥digo <b>07</b> por Falha Gen√©rica</b>]

    E --> F{Ocorreu Erro no Processo da Transa√ß√£o?}
    F -- N√£o --> G{Saldo √© Suficiente?}
    F -- Sim --> K[‚ùå<br/><b>Rejeitada</b><br/> Retorna C√≥digo <b>07</b> por Falha Gen√©rica</b>]
    K --> J
    
    G -- Sim --> H[Atualiza Saldo e Registra Transa√ß√£o Aprovada]
    H --> I[‚úÖ<br/><b>Aprovada</b><br/> Retorna C√≥digo <b>00</b>]
    I --> J[üîì<br/><b>Desbloqueia</b><br/> Account da Transa√ß√£o no <br> Lock Distribu√≠do]

    G -- N√£o --> L[‚ùå<br/><b>Rejeitada</b><br/> Retorna C√≥digo <b>51</b> por Saldo Insuficiente</b>]
    L --> J

    J --> P[‚úâÔ∏è‚û°Ô∏è<br/><b>Publica</b><br/> mensagem de desbloqueio Redis Keyspace Notification]
    P --> Q([‚èπÔ∏è<br/>Fim do Processo])
    O --> Q

    style D fill:#78771b,stroke:#000
    style I fill:#009933,stroke:#000

    style L fill:#cc0000,stroke:#000
    style K fill:#cc0000,stroke:#000
    style O fill:#cc0000,stroke:#000

    style M fill:#007bff,stroke:#000
    style R fill:#007bff,stroke:#000

    style J fill:#78771b,stroke:#000
    style P fill:#007bff,stroke:#000
```

_*Esses diagramas representam uma interpreta√ß√£o do sistema, n√£o sua implementa√ß√£o.<br/>**A etapa [`Processa Autoriza√ß√£o de Pagamento`](#diagrams-flowchart) √© uma sub-rotina vinculada ao diagrama de fluxo de Autoriza√ß√£o de Pagamento, mantida de forma simplificada para que esse fluxograma tenha sentido isoladamente. Considere os detalhes do processamento para o d√©bito de saldos das categorias corretas no fluxograma vinculado._


<br/>
<br/>

O diagrama de fluxo acima foi produzido ap√≥s uma sess√£o de `Miro Board` conduzida pelos proponentes do desafio. O diagrama Miro da proposta de arquitetura, resultado dessa sess√£o, pode ser visto abaixo:

<img src="./docs/assets/images/screen_captures/miro/interview_architecture_proposal_v1.jpeg">

A partir desse diagrama, constru√≠ uma segunda vers√£o com poucas modifica√ß√µes, acrescentando detalhes e contexto para os que n√£o estiveram presentes nessa sess√£o. Esse diagrama gerou o ADR __[0003: gRPC e Redis Keyspace Notification em API REST e Worker para reduzir Lat√™ncia e evitar Concorr√™ncia](./docs/architecture/decisions/0003-grpc-e-redis-keyspace-notification-em-api-rest-e-worker-para-reduzir-latencia-e-evitar-concorrencia.md)__, visando nortear a implementa√ß√£o do requisito L4 neste projeto, com finalidade estritamente de treinamento.

Via de regra, o que foi discutido naquela reuni√£o deve ser implementado.


<br/>

[‚§¥Ô∏è de volta ao √≠ndice](#index)

---

<a id="best-practices"></a>
### üëè Boas Pr√°ticas

- [Swagger](https://swagger.io/)
- [Github Project - Kanban](https://github.com/users/jtonynet/projects/7/views/1)
- [Semantic Versioning 2.0.0](https://semver.org/spec/v2.0.0.html)
- [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/)
- [Keep a Changelog](https://keepachangelog.com/en/1.0.0/)
- [ADR - Architecture Decision Records](https://cognitect.com/blog/2011/11/15/documenting-architecture-decisions)
- [Mermaid Diagrams](https://mermaid.js.org)

<br/>

[‚§¥Ô∏è de volta ao √≠ndice](#index)

---

<a id="adr"></a> 
### üß† ADR - Architecture Decision Records

- [0001: Registro de Decis√µes de Arquitetura (ADR)](./docs/architecture/decisions/0001-registro-de-decisoes-de-arquitetura.md)
- [0002: Go, Gin, Gorm e PostgreSQL com Arquitetura Hexagonal e TDD](./docs/architecture/decisions/0002-go-gin-gorm-e-postgres-com-arquitetura-hexagonal-tdd.md)
- [0003: gRPC e Redis Keyspace Notification em API REST e Worker para reduzir Lat√™ncia e evitar Concorr√™ncia](./docs/architecture/decisions/0003-grpc-e-redis-keyspace-notification-em-api-rest-e-worker-para-reduzir-latencia-e-evitar-concorrencia.md)

<br/>

[‚§¥Ô∏è de volta ao √≠ndice](#index)

---

<a id="versions"></a>
### üî¢ Vers√µes

As tags de vers√µes est√£o sendo criadas manualmente a medida que o projeto avan√ßa com melhorias not√°veis. Cada funcionalidade √© desenvolvida em uma branch a parte (Branch Based, [feature branch](https://www.atlassian.com/git/tutorials/comparing-workflows/feature-branch-workflow)) quando finalizadas √© gerada tag e mergeadas em master.

Para obter mais informa√ß√µes, consulte o [Hist√≥rico de Vers√µes](./CHANGELOG.md).

<br/>

[‚§¥Ô∏è de volta ao √≠ndice](#index)

---

<a id="tools"></a>
### üß∞ Ferramentas


- Linguagem:
  - [Go 1.23](https://go.dev/)
  - [GVM v1.0.22](https://github.com/moovweb/gvm)

- Framework & Libs:
  - [Gin](https://gin-gonic.com/)
  - [GORM](https://gorm.io/index.html)
  - [Viper](https://github.com/spf13/viper)
  - [Gin-Swagger](https://github.com/swaggo/gin-swagger)
  - [gjson](https://github.com/tidwall/gjson)
  - [uuid](github.com/google/uuid)


- Infra & Tecnologias
  - [Docker v24.0.6](https://www.docker.com/)
  - [Docker compose v2.21.0](https://www.docker.com/)
  - [Postgres v16.0](https://www.postgresql.org/)
  - [Redis](https://redis.com/)

- GUIs:
  - [VsCode](https://code.visualstudio.com/)
  - [DBeaver](https://dbeaver.io/)

<br/>

[‚§¥Ô∏è de volta ao √≠ndice](#index)

---

<a id="ia"></a>
### ü§ñ Uso de IA

A figura do cabe√ßalho nesta p√°gina foi criada com a ajuda de intelig√™ncia artificial e um m√≠nimo de retoques e constru√ß√£o no Gimp [<img src="./docs/assets/images/icons/gimp.svg" width="30" height="30 " title="Gimp" alt="Gimp Logo" />](https://www.gimp.org/)

__Os seguintes prompts foram usados para cria√ß√£o no  [Bing IA:](https://www.bing.com/images/create/)__

<details>
  <summary><b>Gopher caixa de mercado</b></summary>
"gopher azul, simbolo da linguagem golang com um bone laranja, trabalhando como caixa de supermercado com algumas maquinhas de cart√£o de credito e cart√µes em cima da mesa, estilo cartoon, historia em quadrinhos, fundo branco chapado para facilitar remo√ß√£o"<b>(sic)</b>
</details>

<br/>

IA tamb√©m √© utilizada em minhas pesquisas e estudos como ferramenta de apoio; no entanto,  __artes e desenvolvimento s√£o, acima de tudo, atividades criativas humanas. Valorize as pessoas!__

Contrate artistas para projetos comerciais ou mais elaborados e aprenda a ser engenhoso!

[‚§¥Ô∏è de volta ao √≠ndice](#index)

<br/>

---

<a id="conclusion"></a>
### üèÅ Conclus√£o

- Defini o modelo hexagonal pois sua abordagem de `ports` and `adapters` proporciona flexibilidade para que o sistema atenda a chamadas `http`, e possa ser facilmente estendido para outras abordagens, como processamento de `mensagens` e `pub/sub` (sugest√£o de solu√ß√£o L4), sem alterar o `core`, garantindo um sistema com separa√ß√£o de responsabilidades.

- Implantar uma vers√£o inicial de `memory lock` (sugest√£o de solu√ß√£o L4).

- Para o L4, uma solu√ß√£o utilizando filas foi proposta, por√©m desconsiderada em uma sess√£o no `Miro Board`. Pretendo criar um `ADR` e tarefas no `Kanban` visando implantar parte do que foi discutido no `Miro`.

- Testes adicionais poderiam ser criados (multiplos cen√°rios de erros nas rotas e servi√ßos). 

- Para al√©m de `locks` e `filas`, testes de carga e performance extras devem ser adicionados, com ferramentas como `JMeter` ou `Gatling`. Eles devem ser incorporados √† rotina de desenvolvimento para garantir implanta√ß√µes seguras de nossos servi√ßos em conjunto com o ciclo de CI.

Essas s√£o minhas considera√ß√µes sobre o que consegui produzir ao longo desse desafio, e continuarei me aplicando aos pontos cegos que n√£o tive tempo ou conhecimento para aprimorar.

üòäüöÄ

<br/>

[‚§¥Ô∏è de volta ao √≠ndice](#index)




<!--
docker stop $(docker ps -aq)
docker rm $(docker ps -aq)
docker rmi $(docker images -q) --force
docker volume rm $(docker volume ls -q) --force
docker network prune -f

docker system prune -a --volumes

sudo systemctl restart docker
-->

